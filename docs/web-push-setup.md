# Web Push (уведомления в браузере)

## Требования

- **HTTPS** (обязательно)
- **Service Worker** (`public/sw.js`) — подписывается на пуши и показывает уведомления
- **VAPID ключи** — для подписки и отправки

## VAPID ключи

Сгенерировать ключи:

```bash
npx web-push generate-vapid-keys
```

Добавить в переменные окружения (Vercel / .env):

- `VAPID_PUBLIC_KEY` — публичный ключ (отдаётся клиенту для подписки)
- `VAPID_PRIVATE_KEY` — приватный ключ (только на сервере для отправки)

## API

- `GET /api/webpush-vapid` — вернуть публичный ключ
- `POST /api/webpush-subscribe` — сохранить подписку: `{ login, subscription }`
- `GET /api/webpush-preferences?login=` — настройки уведомлений по каналам (telegram, webpush) и событиям
- `POST /api/webpush-preferences` — сохранить настройки: `{ login, preferences: { telegram: {...}, webpush: {...} } }`
- `POST /api/webpush-send` — отправить пуш: `{ logins: string[], title, body?, url? }`

## Профиль → Уведомления

- **Кнопка Telegram**: привязка через «Привязать Telegram» (тот же поток, что и для 2FA: tg-link → открытие бота).
- Внутри Telegram: раздел **Перевозки** (Принята, В пути, Доставлено), раздел **Документы** (Счёт оплачен). Переключатели — как в 2FA (TapSwitch).
- **Web Push** — те же разделы и события, переключатели TapSwitch.

### Шаблоны текста для Telegram (при отправке уведомлений)

- **Принята** (accepted): «Создана Перевозка {номер} число мест {N}, вес {кг} кг, объем {м³} м3, платный вес {кг} кг».
- **В пути** (in_transit): «{номер} В пути».
- **Доставлено** (delivered): «Доставлено».
- **Счёт оплачен** (bill_paid): «Счёт по перевозке № {номер} оплачен».

Web Push работает в Chrome, Edge, Firefox; на iOS — только если сайт добавлен на экран «Домой» (PWA) и разрешены уведомления.
