# Web Push: что сделать по шагам

## Шаг 1. Установить зависимости

В корне проекта выполни:

```bash
npm install
```

Так подтянется пакет `web-push`, нужный для отправки уведомлений на сервере.

---

## Шаг 2. Сгенерировать VAPID ключи

В корне проекта выполни:

```bash
npx web-push generate-vapid-keys
```

В консоли появятся две строки, например:

```
Public Key: BN...
Private Key: ...
```

Скопируй их — понадобятся на следующем шаге.

---

## Шаг 3. Добавить ключи в переменные окружения

### Локально (если запускаешь через `vercel dev` или свой сервер)

Создай или отредактируй файл `.env` в корне проекта и добавь:

```
VAPID_PUBLIC_KEY=твой_публичный_ключ
VAPID_PRIVATE_KEY=твой_приватный_ключ
```

Подставь значения из шага 2 (без кавычек, в одну строку).

### На Vercel (продакшен)

1. Зайди в проект на [vercel.com](https://vercel.com).
2. **Settings** → **Environment Variables**.
3. Добавь две переменные:
   - **Name:** `VAPID_PUBLIC_KEY` → **Value:** публичный ключ из шага 2.
   - **Name:** `VAPID_PRIVATE_KEY` → **Value:** приватный ключ из шага 2.
4. Сохрани и при необходимости сделай **Redeploy**, чтобы новые переменные подхватились.

---

## Шаг 4. Убедиться, что Redis настроен

Web Push хранит подписки и настройки в Redis (Upstash).

Проверь, что в окружении заданы:

- `UPSTASH_REDIS_REST_URL`
- `UPSTASH_REDIS_REST_TOKEN`

Если ещё не настроено — см. `UPSTASH_REDIS_SETUP.md`.

---

## Шаг 5. Задеплоить приложение

Закоммить изменения и запушь в репозиторий. После деплоя на Vercel:

- Сайт должен открываться по **HTTPS** (для Web Push это обязательно).
- Файл `public/sw.js` будет доступен по адресу `https://твой-домен/sw.js`.

---

## Шаг 6. Проверить в браузере

1. Открой приложение в **Chrome, Edge или Firefox** (лучше не в мини-приложении Telegram, а в обычной вкладке).
2. Войди в аккаунт.
3. Профиль → **Уведомления**.
4. В блоке **Web Push (браузер)** нажми **«Включить уведомления в браузере»**.
5. Разреши уведомления в диалоге браузера.
6. Включи нужные события переключателями (Ответ принято, В пути и т.д.).

После этого подписка сохраняется на сервере, и ты можешь отправлять пуши через API (см. ниже).

---

## Шаг 7. (Опционально) Отправка тестового пуша

Чтобы проверить отправку, можно вызвать API вручную:

```bash
curl -X POST https://твой-домен.vercel.app/api/webpush-send \
  -H "Content-Type: application/json" \
  -d '{"logins":["твой_логин"],"title":"HAULZ","body":"Тестовое уведомление","url":"/"}'
```

Замени `твой-домен` и `твой_логин` на свои значения. Если подписка сохранена и ключи верные, в браузере должно прийти уведомление.

---

## Краткий чеклист

| # | Действие |
|---|----------|
| 1 | `npm install` |
| 2 | `npx web-push generate-vapid-keys` |
| 3 | Добавить `VAPID_PUBLIC_KEY` и `VAPID_PRIVATE_KEY` в .env и/или Vercel |
| 4 | Проверить Redis (UPSTASH_*) |
| 5 | Задеплоить (git push / Vercel) |
| 6 | Открыть сайт по HTTPS → Профиль → Уведомления → включить Web Push и события |
| 7 | При необходимости — отправить тестовый пуш через `/api/webpush-send` |

После этого можно подключать вызовы `POST /api/webpush-send` к своим событиям (смена статуса перевозки, счёт на оплату и т.д.), проверяя настройки пользователя в `GET /api/webpush-preferences?login=...`.
