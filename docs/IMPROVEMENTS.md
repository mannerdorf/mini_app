# Анализ мини-приложения HAULZ и предложения по улучшению

## 1. Архитектура и структура кода

### Проблема: монолитный App.tsx
- **Факт:** `App.tsx` ~10 000+ строк, десятки компонентов и страниц объявлены в одном файле (HomePage, DashboardPage, ProfilePage, CargoPage, ChatPage, AddCompanyByINNPage, TabBar, модалки и т.д.).
- **Риск:** сложная навигация, тяжёлый merge, высокий шанс конфликтов при работе нескольких разработчиков.
- **Рекомендация:**
  - Вынести страницы в отдельные файлы: `ProfilePage.tsx`, `CargoPage.tsx`, `ChatPage.tsx`, `CompaniesPage.tsx`, `AddCompanyByINNPage.tsx`, `AddCompanyByLoginPage.tsx` и т.д.
  - Вынести переиспользуемые куски в `components/` (например, `TabBar`, `AccountSwitcher`, `CustomerSwitcher`, модалки деталей).
  - Оставить в `App.tsx` только маршрутизацию по вкладкам/экранам и общее состояние (accounts, theme).

### Дублирование компонентов
- **Факт:** Есть две версии одних и тех же компонентов:
  - `components/DateText.tsx` и `components/ui/DateText.tsx`
  - `components/CustomPeriodModal.tsx` и `components/modals/CustomPeriodModal.tsx`
  - `components/FilterDropdownPortal.tsx` и `components/ui/FilterDropdownPortal.tsx`
- **Рекомендация:** Оставить единственный вариант (например, в `components/ui/` и `components/modals/`), удалить дубликаты из корня `components/` и обновить импорты.

---

## 2. Безопасность

### Хранение паролей в localStorage
- **Факт:** Логин и пароль хранятся в `localStorage` (`haulz.accounts`, `haulz.auth`) в открытом виде.
- **Риск:** При XSS или доступе к устройству пароли могут быть скомпрометированы.
- **Рекомендации:**
  - Для зарегистрированных пользователей (CMS) по возможности переходить на сессии (httpOnly cookie + короткоживущий access token), пароль не хранить на клиенте.
  - Для 1С/API-аккаунтов, где хранение учётных данных на клиенте вынуждено: минимизировать время жизни, не хранить в том же ключе, что и CMS; рассмотреть опцию «не сохранять пароль» с вводом при каждом входе.
  - Не логировать и не отправлять пароли в аналитику/ошибки.

### Админка
- **Факт:** Доступ по `ADMIN_LOGIN` / `ADMIN_PASSWORD` из env — нормальная практика.
- **Рекомендация:** Ограничить частоту запросов к `verify-admin-access` и к критичным API админки (rate limit), логировать входы и важные действия (уже есть audit log — использовать его).

---

## 3. Надёжность и UX

### Error Boundary
- **Факт:** Error Boundary есть только в `CMSStandalonePage`. Основное приложение при необработанной ошибке в React может показать белый экран.
- **Рекомендация:** Обернуть корневой рендер (например, дерево внутри `App`) в Error Boundary с fallback-страницей «Что-то пошло не так» и кнопкой перезагрузки.
- **Сделано:** Добавлен `components/ErrorBoundary.tsx`, корень приложения в `main.tsx` обёрнут в `<ErrorBoundary>`; при ошибке показывается «Что-то пошло не так» и кнопка «Обновить страницу».

### Обработка ошибок API
- **Факт:** В `utils.ts` есть `ensureOk`, `extractErrorMessage`, `humanizeStatus` — хорошая база. В части мест ошибки обрабатываются локально (try/catch + setError), в части — могут остаться необработанными.
- **Рекомендация:** Единый слой для вызова API (например, обёртка над `fetch` с проверкой `res.ok`, разбором JSON и выбросом ошибки с текстом от сервера), использовать его везде и показывать пользователю сообщение из ответа.
- **Сделано:** В `utils.ts` добавлены `apiFetch(input, init)` (возвращает `Response`, при `!res.ok` бросает `Error` с текстом от сервера) и `apiFetchJson<T>(input, init)` (парсит JSON и возвращает его, при ошибке — то же). В `hooks/useApi.ts` все fetcher'ы переведены на `apiFetchJson`; сообщение об ошибке приходит из `error`/`message` ответа и показывается пользователю через `error?.message` в хуках.

### Состояния загрузки
- **Факт:** Во многих местах есть `loading` и спиннеры; в других — запрос уходит без индикатора.
- **Рекомендация:** Для всех действий «отправить форму / загрузить данные» показывать явный loading (кнопка с спиннером или скелетон списка), чтобы пользователь не нажимал повторно и понимал, что идёт запрос.

---

## 4. Производительность

### Размер бандла
- **Факт:** Один большой `App.tsx`, lazy только для `DocumentsPage`, много зависимостей (FFmpeg, Firebase, OpenAI и т.д.).
- **Рекомендации:**
  - Расширить lazy loading: подгружать по мере перехода на вкладку/экран `ProfilePage`, `CargoPage`, `ChatPage`, админку (если вынесена), тяжёлые модалки.
  - Проверить, что FFmpeg/Firebase подключаются только на экранах, где они реально нужны (динамический import).
  - После разбиения App — анализировать бандл (e.g. `vite build --mode analyze` при наличии плагина) и вырезать неиспользуемый код.

### Списки (перевозки, документы)
- **Факт:** Длинные списки рендерятся целиком.
- **Рекомендация:** При росте объёма данных добавить виртуализацию (например, `react-window` или `@tanstack/react-virtual`) для списков перевозок и документов.

---

## 5. Доступность и унификация UI

### Высота полей и кнопок
- **Факт:** Уже введены классы `admin-users-toolbar`, `admin-audit-toolbar`, `form-row-same-height` для единой высоты 36px.
- **Рекомендация:** Последовательно применять `form-row-same-height` во всех формах (логин, добавление компании, настройки и т.д.), чтобы везде высота полей ввода и кнопок была одинаковой.

### A11y
- **Рекомендации:**
  - У интерактивных элементов указывать `aria-label` там, где текст неочевиден (иконки, кнопки «подробнее»).
  - Формы связывать с лейблами (`<label htmlFor=...>`) там, где этого ещё нет.
  - Модальные окна при открытии ловить фокус и возвращать его при закрытии; блокировать фокус с помощью trap (например, focus-trap-react).

---

## 6. Тестирование и качество

### Тесты
- **Факт:** В проекте не видно юнит- или e2e-тестов.
- **Рекомендация:** Начать с тестов на критичные утилиты (`utils.ts`, `formatUtils`, `dateUtils`, `statusUtils`) и на ключевые API-хендлеры (auth, perevozki, my-employees). Затем добавить несколько e2e-сценариев (логин, список перевозок, открытие документа).

### Типизация
- **Факт:** Используется TypeScript, типы заданы в `types.ts` и по файлам; в части мест используется `any`.
- **Рекомендация:** Постепенно заменять `any` на конкретные типы (ответы API, пропсы модалок, данные перевозок/документов), чтобы ловить ошибки на этапе компиляции.

---

## 7. API и бэкенд

### Структура API
- **Факт:** Много отдельных файлов в `api/` (perevozki, download, invoices, acts, admin-*, my-employees и т.д.) — понятная структура.
- **Рекомендация:** Держать общую middleware для CORS, парсинга тела, логирования ошибок и, при необходимости, rate limit, чтобы не дублировать код в каждом хендлере.

### Миграции
- **Факт:** Миграции 001–020 лежат в `migrations/`, есть `run_all.sql` (частично).
- **Рекомендация:** Завести простой порядок применения (например, таблица `schema_migrations` с номером последней применённой миграции) и скрипт/инструкцию для деплоя, чтобы на каждой среде применялись только недостающие миграции.

---

## 8. Документация и деплой

### README / конфиг
- **Рекомендация:** В README указать: как поднять проект локально, какие env-переменные нужны (БД, ADMIN_*, SMTP, при необходимости ключи 1С/внешних API), как применить миграции и как собирать/деплоить на Vercel.

### Переменные окружения
- **Рекомендация:** Описать в README или в `env.example` все переменные (DATABASE_URL, ADMIN_LOGIN, ADMIN_PASSWORD, SMTP_*, и т.д.), без значений, чтобы новый разработчик понимал, что нужно задать.

---

## Приоритизация

| Приоритет | Что сделать в первую очередь |
|-----------|------------------------------|
| Высокий   | Error Boundary для всего приложения; единая обработка ошибок API; не хранить пароли в открытом виде там, где можно использовать сессии. |
| Средний   | Разбить App.tsx на страницы и компоненты; убрать дубликаты DateText/CustomPeriodModal/FilterDropdownPortal; lazy loading тяжёлых экранов. |
| Низкий    | Виртуализация длинных списков; расширенные тесты; детальная документация и env.example. |

Файл создан для внутреннего использования и дальнейшего планирования спринтов.
