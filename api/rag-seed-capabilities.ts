import type { VercelRequest, VercelResponse } from "@vercel/node";
import { upsertDocument } from "../lib/rag.js";

/**
 * Заполнение RAG документами «что умеет Грузик» и «примеры запросов».
 * Вызови один раз после деплоя или при добавлении новых сценариев.
 * GET или POST без тела — выполнит ingest.
 */
const CAPABILITIES_DOC = {
  sourceType: "capability",
  sourceId: "gruzik_abilities",
  title: "Что умеет Грузик",
  content: `Грузик — AI-помощник HAULZ. Возможности:

1. ПЕРЕВОЗКИ (API get_perevozki)
- Список перевозок за период: за сегодня, за неделю, за месяц, за вчера.
- Фильтр по статусу: в пути, готов к выдаче, на доставке, доставлено.
- Фильтр по типу: паром, авто.
- Фильтр по маршруту: Москва–Калининград (MSK-KGD), Калининград–Москва (KGD-MSK).
- Фильтр по оплате: не оплачен, оплачен, частично, отменён.
- По контрагенту: отправитель, получатель, заказчик.
- Комбинации: например «перевозки в пути за неделю», «неоплаченные паромом за месяц».

2. КОНТАКТЫ (API get_contacts)
- Адреса офисов, телефон, email, сайт HAULZ.

3. ДОКУМЕНТЫ ПО ПЕРЕВОЗКЕ
- ЭР, Счет, УПД, АПП по номеру перевозки (в веб-чате и Telegram).

4. ПОЛНАЯ ИНФОРМАЦИЯ ПО НОМЕРУ
- Детали перевозки по номеру из базы знаний (RAG).

Используй инструменты get_perevozki и get_contacts когда пользователь явно просит список перевозок или контакты. Для перевозок нужны учётные данные (логин/пароль) из контекста сессии.`,
};

const EXAMPLES_DOC = {
  sourceType: "capability",
  sourceId: "gruzik_examples",
  title: "Примеры запросов пользователей",
  content: `Варианты запросов, которые понимает Грузик:

ПЕРЕВОЗКИ:
- перевозки за сегодня; что за сегодня; грузы на сегодня;
- перевозки за неделю; за последнюю неделю; что за неделю;
- перевозки за месяц; за последний месяц;
- что в пути; перевозки в пути; отправленные;
- готовые к выдаче; готов к выдаче;
- на доставке; доставляются;
- доставлено; доставленные; что уже доставлено;
- паромом; паром; перевозки паромом;
- авто; автомобилем; перевозки авто;
- Москва Калининград; МСК КГД; туда;
- Калининград Москва; КГД МСК; обратно;
- неоплаченные; не оплачен; долги; какие счета не оплачены;
- оплаченные; оплачен;
- перевозки в пути за неделю; неоплаченные за месяц; паромом за сегодня;
- по отправителю ООО Ромашка; по заказчику X; по получателю Y;

КОНТАКТЫ:
- контакты; адрес; телефон; email; сайт; офис; как связаться;

ДОКУМЕНТЫ И ПЕРЕВОЗКА:
- документы по перевозке 12345; ЭР по 12345; счет на перевозку; УПД; АПП;
- полная информация по перевозке 12345; что по перевозке 12345;

ОБЩЕЕ:
- привет; что умеешь; помощь; отвяжи компанию.`,
};

export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== "GET" && req.method !== "POST") {
    res.setHeader("Allow", "GET, POST");
    return res.status(405).json({ error: "Method not allowed" });
  }

  try {
    const r1 = await upsertDocument(CAPABILITIES_DOC);
    const r2 = await upsertDocument(EXAMPLES_DOC);
    return res.status(200).json({
      ok: true,
      message: "RAG capability docs seeded",
      gruzik_abilities: { documentId: r1.documentId, chunks: r1.chunks },
      gruzik_examples: { documentId: r2.documentId, chunks: r2.chunks },
    });
  } catch (err: any) {
    console.error("rag-seed-capabilities error:", err?.message || err);
    return res.status(500).json({ error: err?.message || "Seed failed" });
  }
}
