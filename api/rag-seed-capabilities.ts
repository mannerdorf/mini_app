import type { VercelRequest, VercelResponse } from "@vercel/node";
import { getPool } from "./_db.js";

/**
 * Заполнение таблицы chat_capabilities («что умеет Грузик» и «примеры запросов»).
 * GET или POST — выполнит upsert в chat_capabilities.
 */
const CAPABILITIES_DOC = {
  slug: "gruzik_abilities",
  title: "Что умеет Грузик",
  content: `Грузик — AI-помощник HAULZ. Возможности:

1. ПЕРЕВОЗКИ (API get_perevozki)
- Список перевозок за период: за сегодня, за неделю, за месяц, за вчера.
- Фильтр по статусу: в пути, готов к выдаче, на доставке, доставлено.
- Фильтр по типу: паром, авто.
- Фильтр по маршруту: Москва–Калининград (MSK-KGD), Калининград–Москва (KGD-MSK).
- Фильтр по оплате: не оплачен, оплачен, частично, отменён.
- По контрагенту: отправитель, получатель, заказчик.
- Комбинации: например «перевозки в пути за неделю», «неоплаченные паромом за месяц».

2. КОНТАКТЫ (API get_contacts)
- Адреса офисов, телефон, email, сайт HAULZ.

3. ДОКУМЕНТЫ ПО ПЕРЕВОЗКЕ
- ЭР, Счет, УПД, АПП по номеру перевозки (в веб-чате и Telegram).

4. ПОЛНАЯ ИНФОРМАЦИЯ ПО НОМЕРУ
- Детали перевозки по номеру из базы знаний (RAG).

Используй инструменты get_perevozki и get_contacts когда пользователь явно просит список перевозок или контакты. Для перевозок нужны учётные данные (логин/пароль) из контекста сессии.`,
};

const EXAMPLES_DOC = {
  slug: "gruzik_examples",
  title: "Примеры запросов пользователей",
  content: `Варианты запросов (как фильтры на странице Грузы). Любые комбинации период + статус + тип + маршрут + оплата + контрагент.

ПЕРИОД (обязательно понимать):
- за сегодня; на сегодня; что за сегодня; грузы на сегодня; перевозки сегодня;
- за вчера; вчера; что было вчера;
- за неделю; за последнюю неделю; за 7 дней; что за неделю; перевозки за неделю;
- за месяц; за последний месяц; за 30 дней; что за месяц; перевозки за месяц;
- за год; за этот год; перевозки за год;
- за период; за полгода; все перевозки; все грузы (как «все» на странице Грузы);

СТАТУС перевозки:
- в пути; перевозки в пути; отправленные; что в пути; что отправлено;
- готов к выдаче; готовые к выдаче; готовые; что готово к выдаче;
- на доставке; доставляются; что на доставке;
- доставлено; доставленные; что уже доставлено; завершённые;
- избранные (если есть такой фильтр);

ТИП перевозки:
- паромом; паром; перевозки паромом; паромные;
- авто; автомобилем; перевозки авто; автоперевозки;

МАРШРУТ:
- Москва Калининград; МСК КГД; МСК–КГД; туда; в Калининград из Москвы;
- Калининград Москва; КГД МСК; КГД–МСК; обратно; в Москву из Калининграда;

ОПЛАТА счёта:
- не оплачен; неоплаченные; долги; какие счета не оплачены; что не оплачено;
- оплачен; оплаченные; что оплачено;
- частично оплачен; частичная оплата;
- отменён; отменённые счета;

ПО КОНТРАГЕНТУ (название компании/ИП):
- по отправителю ООО Ромашка; от отправителя X; от кого перевозки;
- по получателю …; для получателя …; получатель Y;
- по заказчику …; заказчик Z;

КОМБИНАЦИИ (примеры — можно любые сочетания):
- перевозки в пути за неделю; что в пути за сегодня;
- неоплаченные за месяц; неоплаченные счета за неделю;
- паромом за сегодня; паромные перевозки за месяц;
- авто Москва Калининград за неделю; автоперевозки МСК КГД за месяц;
- доставлено за месяц; готовые к выдаче за неделю;
- по отправителю ООО X за месяц; по заказчику Y в пути за неделю;
- неоплаченные паромом за месяц; оплаченные авто за сегодня;
- в пути Калининград Москва за неделю;

КОНТАКТЫ:
- контакты; адрес; телефон; email; сайт; офис; как связаться; реквизиты HAULZ;

ДОКУМЕНТЫ по номеру перевозки:
- документы по перевозке 12345; ЭР по 12345; счет на перевозку 12345; УПД; АПП;
- полная информация по перевозке 12345; что по перевозке 12345; детали перевозки 12345;

ОБЩЕЕ:
- привет; что умеешь; помощь; отвяжи компанию; отвяжи заказчика.`,
};

/** Шпаргалка: как фразы пользователя соответствуют фильтрам (как на странице Грузы) */
const FILTERS_REF_DOC = {
  slug: "gruzik_filters_ref",
  title: "Соответствие фраз и фильтров",
  content: `Период: сегодня/на сегодня → today; вчера → yesterday; неделя/7 дней → week; месяц/30 дней → month; год → year; все/полгода → all.
Статус: в пути/отправленные → in_transit; готов к выдаче/готовые → ready; на доставке → delivering; доставлено/доставленные → delivered.
Тип: паром/паромом → ferry; авто/автомобилем → auto.
Маршрут: Москва Калининград/МСК КГД/туда → MSK-KGD; Калининград Москва/КГД МСК/обратно → KGD-MSK.
Оплата: не оплачен/долги → unpaid; оплачен → paid; частично → partial; отменён → cancelled.
Контрагент: по отправителю/от … → sender; по получателю/для … → receiver; по заказчику → customer.`,
};

/** Варианты запросов за период и формат ответа */
const PERIOD_QUERIES_DOC = {
  slug: "gruzik_period_queries",
  title: "Запросы за период — варианты и формат ответа",
  content: `Варианты запросов (все трактуй как «сводка за период»):
перевозки за неделю; сводка за неделю; саммари недели; за период принято; сколько перевозок за месяц; итого за неделю; сумма за месяц; платный вес за период; что за неделю; грузы за месяц; принято за неделю; статистика за месяц; сводка недели; кратко за период; перевозки за месяц; за сегодня; за вчера; что за месяц; итого за месяц.

Формат ответа (кратко, без перечисления всех перевозок):
«За [неделю/месяц/сегодня] принято N перевозок на сумму X руб., платный вес Y кг.» При необходимости добавь мест или объём. Данные бери из cargoList в контексте: посчитай количество, сложи sum и платный вес (PW).`,
};

export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== "GET" && req.method !== "POST") {
    res.setHeader("Allow", "GET, POST");
    return res.status(405).json({ error: "Method not allowed" });
  }

  try {
    const pool = getPool();
    for (const doc of [CAPABILITIES_DOC, EXAMPLES_DOC, FILTERS_REF_DOC, PERIOD_QUERIES_DOC]) {
      await pool.query(
        `insert into chat_capabilities (slug, title, content, updated_at)
         values ($1, $2, $3, now())
         on conflict (slug) do update set title = excluded.title, content = excluded.content, updated_at = now()`,
        [doc.slug, doc.title, doc.content],
      );
    }
    const baseUrl = process.env.VERCEL_URL
      ? `https://${process.env.VERCEL_URL}`
      : process.env.NEXT_PUBLIC_APP_URL || "https://ваш-домен.vercel.app";
    return res.status(200).json({
      ok: true,
      message: "chat_capabilities seeded",
      slugs: [CAPABILITIES_DOC.slug, EXAMPLES_DOC.slug, FILTERS_REF_DOC.slug, PERIOD_QUERIES_DOC.slug],
      link: `${baseUrl}/api/rag-seed-capabilities`,
    });
  } catch (err: any) {
    console.error("rag-seed-capabilities error:", err?.message || err);
    return res.status(500).json({ error: err?.message || "Seed failed" });
  }
}
