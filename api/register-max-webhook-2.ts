/**
 * –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è webhook –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ —á–∞—Ç-–±–æ—Ç–∞ –≤ MAX.
 *
 * –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: MAX_BOT_TOKEN_2
 *
 * –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –≤—ã–∑–æ–≤–∏:
 *   GET –∏–ª–∏ POST https://<–¥–æ–º–µ–Ω>/api/register-max-webhook-2
 * Webhook –±—É–¥–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞: https://<–¥–æ–º–µ–Ω>/api/max-webhook-2
 */

import type { VercelRequest, VercelResponse } from "@vercel/node";

const MAX_API_BASE = "https://platform-api.max.ru";

export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== "POST" && req.method !== "GET") {
    res.setHeader("Allow", "POST, GET");
    return res.status(405).json({ error: "Method not allowed" });
  }

  const MAX_BOT_TOKEN = process.env.MAX_BOT_TOKEN_2;
  if (!MAX_BOT_TOKEN) {
    return res.status(500).json({
      error: "MAX_BOT_TOKEN_2 is not configured. Add it in Vercel Environment Variables.",
    });
  }

  const host = req.headers.host || req.headers["x-forwarded-host"];
  const protocol = req.headers["x-forwarded-proto"] || "https";
  const webhookUrl = `${protocol}://${host}/api/max-webhook-2`;

  let body: any = {};
  if (req.method === "POST") {
    if (typeof req.body === "string") {
      try {
        body = JSON.parse(req.body);
      } catch {}
    } else {
      body = req.body || {};
    }
  }

  const finalWebhookUrl = body.url || webhookUrl;

  if (!finalWebhookUrl.startsWith("https://")) {
    return res.status(400).json({
      error: "Webhook URL must be HTTPS",
      detected: webhookUrl,
    });
  }

  try {
    console.log("üîó Registering MAX webhook-2:", finalWebhookUrl);

    const response = await fetch(`${MAX_API_BASE}/subscriptions`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: MAX_BOT_TOKEN,
      },
      body: JSON.stringify({
        url: finalWebhookUrl,
        events: ["message"],
      }),
    });

    const result = await response.json();

    if (!response.ok) {
      console.error("‚ùå MAX API error (webhook-2):", response.status, result);
      return res.status(response.status).json({
        error: "Failed to register webhook-2 in MAX",
        status: response.status,
        details: result,
        webhookUrl: finalWebhookUrl,
      });
    }

    console.log("‚úÖ Webhook-2 registered:", finalWebhookUrl);

    return res.status(200).json({
      success: true,
      message: "Webhook for second MAX bot registered successfully",
      webhookUrl: finalWebhookUrl,
      result,
    });
  } catch (error: any) {
    console.error("üî• Webhook-2 registration error:", error);
    return res.status(500).json({
      error: "Failed to register webhook-2",
      message: error?.message || String(error),
      webhookUrl: finalWebhookUrl,
    });
  }
}
